<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<link th:replace="common/fragment::base"/>
<script type="text/javascript" th:src="@{/static/tool/showdown.min.js}"></script>
<script type="text/javascript" th:src="@{/static/tool/highlight.pack.js}"></script>
<link rel="stylesheet" th:href="@{/static/tool/github-markdown.css}">
<link rel="stylesheet" th:href="@{/static/tool/github-gist.css}">

<style type="text/css">
.right {
    display: inline-block;
    vertical-align: middle;
    width: 0;
    height: 0;
    margin-left: 4px;
    opacity: 0.66;
    border-bottom: 5px solid transparent;
    border-top: 5px solid transparent;
    border-left:5px solid red;
}
.left {
    display: inline-block;
    vertical-align: middle;
    width: 0;
    height: 0;
    margin-left: 4px;
    opacity: 0.66;
    border-bottom: 5px solid transparent;
    border-top: 5px solid transparent;
    border-right:5px solid red;
}
</style>
<script type="text/javascript" th:inline="javascript">

var img = {};

let config = {
	//添加请求头
    headers: { "Content-Type": "multipart/form-data" }
 };

function upload(file) {
	var formData = new FormData();
	formData.append("mFile", file);
	
	axios.post(contextPath + "uploadImg/uploadFaq", formData, config).then(function(r) {
		alert(JSON.stringify(r));
	})
	
	/*
	$.ajax({url:[[@{/uploadImg/uploadFaq}]], type:"post", contentType:false, data:formData ,processData:false,
		success:function(r) {
			
		}
	})*/
}

var form;
window.onload = function() {
	// 截图，用Ctrl+v
	document.body.addEventListener('paste', function(e) {
		if (e.clipboardData) {
			for(var i = 0; i < e.clipboardData.items.length; i++) {
				var c = e.clipboardData.items[i];
	          	var f = c.getAsFile();
	          	if (f) {
					upload(f);
	          	}
	        }
		}
	})
	
	form = new Vue({
	    el:'#faq',
	    data:{val:""},
	    computed:{
	    	content:function() {
	    		return getMarkdown(this.val);
	    	}
	    },
	    watch: {
	    	val(n, o) {
		    	this.$nextTick(function () {
		    		const preEl = document.getElementById("content").querySelectorAll('code');
		    		preEl.forEach((el) => {
		    			hljs.highlightBlock(el)
		    		})
	    		})
	    	}
	    }
	})
}

function getMarkdown(val) {
	var i = 0;
	var newVal = val.replace(/<m>/g, function() {
		i++;
		var arrowId = 'arrow' + i;
		var divId = 'div' + i;
		return  '<a href="#this" onclick="more(' + i + ')">more</a><span id="' + arrowId + '" class="left"></span>' +
			'<div id="' + divId + '" style="margin-top:-15px;margin-bottom:-15px;display:none">';
	});
	newVal = newVal.replace(/<\/m>/g, '</div>');
	
	var converter = new showdown.Converter();
	var r = converter.makeHtml(newVal);
	return r;
}

function more(i) {
	var arrowObj = document.getElementById("arrow" + i);
	var divObj = document.getElementById("div" + i);
	
	var direction = arrowObj.getAttribute("class");
	direction = direction == 'left' ? 'right' : 'left';
	alert(direction)
	arrowObj.setAttribute("class", direction);
	
	var display = divObj.style.display == 'none' ? '' : 'none';
	divObj.style.display = display;
}

</script>
</head>
<body>

<div id="faq">

	<div><textarea style="width:500px" rows="8" v-model="val"></textarea></div>
	
	<div id="content" v-html="content" class="markdown-body"></div>
	
</div>

</body>
</html>